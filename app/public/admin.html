<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ Christmas Experience Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #FFD700, #FF69B4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #FFD700;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-family: inherit;
            font-size: 14px;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 30px;
            border: 2px dashed rgba(255, 215, 0, 0.4);
            border-radius: 8px;
            background: rgba(255, 215, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .file-upload-label:hover {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .file-list {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .file-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-generate {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            flex: 1;
            max-width: 300px;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
        }

        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FF69B4);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .status-success {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            color: #0F0;
        }

        .status-error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #FF6B6B;
        }

        .status-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #FFD700;
        }

        .result-section {
            display: none;
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .result-url {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .copy-btn {
            background: #00AA00;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéÑ Magic Christmas Generator</h1>
      <p class="subtitle">Create personalized interactive 3D Christmas experiences</p>
    </header>

    <form id="generatorForm">
      <div class="form-section">
        <h3 style="margin-bottom: 20px; color: #FFD700;">Basic Information</h3>

        <div class="form-group">
            <label for="projectName">Project Name</label>
            <input type="text" id="projectName" name="projectName" placeholder="e.g., my-project-name (letters, digits, hyphens only)" required>
        </div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom: 20px; color: #FFD700;">Upload Images & Media</h3>

        <div class="form-group">
          <label>Body Images (Ornaments) * - 5 to 15 (required)</label>
          <div>
            <label for="bodyImages" class="file-upload-label">üñºÔ∏è Click or drag images here (5-15 images)</label>
            <input type="file" id="bodyImages" name="bodyImages" accept="image/*" multiple required style="display:none;">
          </div>
          <div id="bodyPreview" class="file-list"></div>
        </div>

        <div class="form-group">
          <label>Background Music (Optional)</label>
          <div>
            <label for="music" class="file-upload-label">üéµ Click or drag audio file here</label>
            <input type="file" id="music" name="music" accept="audio/*" style="display:none;">
          </div>
          <div id="musicPreview"></div>
        </div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom: 20px; color: #FFD700;">Customization</h3>

        <div class="form-group">
          <label for="mainTitle">Main Title</label>
          <input type="text" id="mainTitle" name="mainTitle" placeholder="MERRY CHRISTMAS" value="MERRY CHRISTMAS">
        </div>

        <div class="form-group">
          <label for="loveText">Love Text</label>
          <input type="text" id="loveText" name="loveText" placeholder="I LOVE YOU ‚ù§Ô∏è" value="I LOVE YOU ‚ù§Ô∏è">
        </div>

        <div class="form-group">
          <label for="treeType">Tree Type</label>
          <select id="treeType" name="treeType">
            <option value="tree1">Tree 1 (Classic)</option>
            <option value="tree2">Tree 2 (Neon)</option>
            <option value="tree3">Tree 3 (Snow Crystal)</option>
            <option value="tree4">Tree 4 (Golden Luxury)</option>
            <option value="tree5">Tree 5 (Rainbow Magic)</option>
          </select>
        </div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom: 20px; color: #FFD700;">Deploy Settings</h3>

        <div class="form-group">
          <label>Deploy To</label>
          <div style="padding:12px; border:1px solid rgba(255,215,0,0.1); border-radius:8px; background: rgba(255,255,255,0.02); color:#fff; font-weight:600;">
            AWS S3 (Public)
          </div>
          <input type="hidden" id="deployTo" name="deployTo" value="s3">
        </div>

        <div class="button-group">
          <button type="reset" class="btn-generate" style="background: rgba(255,255,255,0.1); color: #fff;">Reset</button>
          <button type="submit" class="btn-generate">üöÄ Generate & Deploy</button>
        </div>

        <div class="progress-section" id="progressSection">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div id="statusMessage" class="status-message status-info"></div>
        </div>

        <div class="result-section" id="resultSection">
          <h3 style="color: #0F0; margin-bottom: 15px;">‚úÖ Success!</h3>
          <p style="margin-bottom: 10px;">Your Christmas experience is ready:</p>
          <div class="result-url" id="resultUrl"></div>
          <button type="button" class="copy-btn" onclick="copyUrl()">üìã Copy URL</button>
        </div>
      </div>
    </form>
  </div>

<script>
const form = document.getElementById('generatorForm');
const bodyImagesInput = document.getElementById('bodyImages');
const musicInput = document.getElementById('music');

const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
const MIN_IMAGES = 5;
const MAX_IMAGES = 15;
const MAX_NAME_LEN = 63;
const NAME_ALLOWED_RE = /^[a-z0-9-]+$/i;

// sanitize a raw project name into a safe slug for S3/subdomain
function sanitizeProjectName(raw) {
  if (!raw) return '';
  let s = raw.trim().toLowerCase();
  // replace invalid chars (including spaces) with hyphen
  s = s.replace(/[^a-z0-9-]+/g, '-');
  // collapse multiple hyphens
  s = s.replace(/-+/g, '-');
  // trim leading/trailing hyphens
  s = s.replace(/(^-+|-+$)/g, '');
  // enforce max length
  if (s.length > MAX_NAME_LEN) s = s.slice(0, MAX_NAME_LEN);
  return s;
}

function showMessage(msg, type) {
  const statusEl = document.getElementById('statusMessage');
  statusEl.textContent = msg;
  statusEl.className = `status-message status-${type}`;
}

function updateProgress(percent) {
  document.getElementById('progressFill').style.width = percent + '%';
}

// File previews with size check
bodyImagesInput.addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  const preview = document.getElementById('bodyPreview');
  preview.innerHTML = '';

  const oversized = files.find(f => f.size > MAX_FILE_SIZE);
  if (oversized) {
    showMessage(`File "${oversized.name}" exceeds 5 MB limit`, 'error');
    bodyImagesInput.value = '';
    preview.innerHTML = '';
    return;
  }

  files.forEach((file) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = document.createElement('img');
      img.src = ev.target.result;
      img.className = 'file-preview';
      preview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});

// Music preview (unchanged behavior)
musicInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  const musicPreview = document.getElementById('musicPreview');
  if (file) {
    musicPreview.innerHTML = `
      <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
        üéµ ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)
      </div>
    `;
  } else {
    musicPreview.innerHTML = '';
  }
});

// Form submission
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  // Project name validation & sanitization
  const projectInput = document.getElementById('projectName');
  const rawName = (projectInput.value || '').trim();
  if (!rawName) {
    showMessage('Project name is required', 'error');
    return;
  }

  // If raw name already valid and within length, accept it
  if (!NAME_ALLOWED_RE.test(rawName) || rawName.length > MAX_NAME_LEN || rawName.startsWith('-') || rawName.endsWith('-')) {
    // try to sanitize
    const sanitized = sanitizeProjectName(rawName);
    if (!sanitized) {
      showMessage('Project name contains invalid characters and cannot be sanitized. Use letters, digits or hyphens only.', 'error');
      return;
    }
    // set sanitized value back to field so server gets safe name
    projectInput.value = sanitized;
    showMessage(`Project name sanitized to "${sanitized}"`, 'info');
  }

  // Validate body images count
  const files = Array.from(bodyImagesInput.files || []);
  if (files.length < MIN_IMAGES || files.length > MAX_IMAGES) {
    showMessage(`Please upload between ${MIN_IMAGES} and ${MAX_IMAGES} body images`, 'error');
    return;
    }

  // Final size check
  const oversized = files.find(f => f.size > MAX_FILE_SIZE);
  if (oversized) {
    showMessage(`File "${oversized.name}" exceeds 5 MB limit`, 'error');
    return;
  }

  // Build FormData from the form, enforce deployTo=s3, and replace bodyImages with discrete fields
  const formData = new FormData(form);
  formData.set('deployTo', 's3');
  // remove original multi-file field to avoid duplicate handling on server
  formData.delete('bodyImages');

  for (let i = 0; i < files.length; i++) {
    formData.append(`bodyImage${i}`, files[i]);
  }

  showMessage('Uploading files...', 'info');
  document.getElementById('progressSection').style.display = 'block';
  document.getElementById('resultSection').style.display = 'none';
  updateProgress(10);

  try {
    const response = await fetch('/api/generate', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (response.ok) {
      updateProgress(100);
      showMessage(`‚úÖ Success! Generated in ${data.generationTime}ms`, 'success');
      document.getElementById('resultUrl').textContent = data.publicUrl;
      document.getElementById('resultSection').style.display = 'block';
    } else {
      updateProgress(0);
      showMessage(`‚ùå ${data.error || 'Generation failed'}`, 'error');
    }
  } catch (err) {
    updateProgress(0);
    showMessage(`‚ùå Upload failed: ${err.message}`, 'error');
  }
});

function copyUrl() {
  const url = document.getElementById('resultUrl').textContent;
  navigator.clipboard.writeText(url).then(() => {
    alert('URL copied to clipboard!');
  });
}
</script>